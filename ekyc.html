<!DOCTYPE html>
<html lang="lo">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eKYC - Unitel</title>
    <!-- Load Tailwind CSS for modern styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'unitel-orange': '#ff6600',
                        'unitel-dark-orange': '#e65c00',
                        'unitel-grey': '#f7f7f7',
                        'success-light': '#e6ffe6', /* Light green for status bar */
                        'success-dark': '#4CAF50',
                        'warning-light': '#fff3e0', /* Light orange for warning */
                        'warning-dark': '#ff9800',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the phone graphic and animation */
        .phone-graphic-container {
            position: relative;
            width: 150px;
            height: 200px;
            margin: 30px auto;
        }

        .phone-graphic {
            width: 100px;
            height: 180px;
            border: 4px solid #333;
            border-radius: 20px;
            background-color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .unitel-logo {
            font-weight: bold;
            color: #ff6600;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .screen-display {
            background-color: #f0f0f0;
            padding: 5px;
            margin: 15px auto 0;
            width: 80%;
            border-radius: 5px;
            font-weight: bold;
            color: #333;
            font-size: 10px;
            overflow: hidden;
            white-space: nowrap;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            padding: 10px;
            width: 80px;
            margin: 10px auto 0;
            background-color: #f0f0f0;
            border-radius: 5px;
        }

        .key {
            background-color: #fff;
            border: 1px solid #ccc;
            height: 15px;
            border-radius: 3px;
        }

        /* Orange Rings Animation */
        .ring-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            border: 3px solid rgba(255, 102, 0, 0.5);
            border-radius: 50%;
            box-sizing: border-box;
            animation: pulse 2s infinite ease-out;
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }

        /* Responsive Input Field for OTP */
        .otp-input-field {
            letter-spacing: 15px;
            text-align: center;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 350px;
            text-align: center;
        }

        /* Styles for Data Display Step */
        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .data-label {
            text-align: left;
            font-size: 14px;
            color: #555;
            flex: 1;
        }

        .data-value {
            text-align: right;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            flex: 1.5;
            word-break: break-word;
            /* Allow long addresses to wrap */
        }

        .app-header {
            background-color: #ff6600;
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            max-width: inherit;
            /* Inherit max-width from parent */
            z-index: 50;
        }

        /* Ensures the header sits correctly within the main wrapper */
        .relative.w-full.max-w-lg.mx-auto .app-header {
            left: 50%;
            transform: translateX(-50%);
            max-width: 512px;
            /* Tailwind's max-w-lg is 512px */
        }


        .content-padding {
            padding-top: 80px;
            /* Space for the fixed header */
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body class="bg-unitel-grey flex items-start justify-center min-h-screen">

    <!-- Main Wrapper: All content is contained here -->
    <div class="relative w-full max-w-lg mx-auto bg-white min-h-screen shadow-xl">

        <!-- Fixed Header for Steps 3, 4, 5 -->
        <div id="fixed-header" class="app-header hidden">
            <!-- Back button: Function is set dynamically in JS based on current step -->
            <button id="header-back-button" onclick=""
                class="text-white text-2xl p-2 hover:text-gray-200 transition duration-150">
                &leftarrow;
            </button>
            <div id="header-title" class="text-lg font-bold">
                eKYC
            </div>
            <!-- Placeholder for Laos Flag -->
            <img src="https://placehold.co/30x20/F00/FFF?text=LA" alt="Laos Flag"
                class="rounded border border-gray-300">
        </div>

        <!-- Main Content Area -->
        <div class="p-6 sm:p-10 w-full" id="main-content-area">

            <!-- Steps 1 & 2 Container (Centered with Phone Graphic) -->
            <div id="auth-steps-container"
                class="flex flex-col items-center justify-center min-h-[calc(100vh-80px)] text-center">
                <!-- Header: Logo and Flag (Only visible for Step 1 & 2) -->
                <div class="flex justify-between items-center mb-6 w-full max-w-sm">
                    <div class="text-2xl font-extrabold text-unitel-orange">e<span class="text-black">KYC</span></div>
                    <!-- Placeholder for Laos Flag -->
                    <img src="https://placehold.co/30x20/F00/FFF?text=LA" alt="Laos Flag"
                        class="rounded border border-gray-300">
                </div>

                <!-- Phone Graphic and Animation (Only visible for Step 1 & 2) -->
                <div class="phone-graphic-container">
                    <div class="ring-animation"></div>
                    <div class="phone-graphic">
                        <div class="unitel-logo">unitel.</div>
                        <div id="phone-display" class="screen-display">020 XXX XXXX</div>
                        <div class="keypad">
                            <div class="key"></div>
                            <div class="key"></div>
                            <div class="key"></div>
                            <div class="key"></div>
                            <div class="key"></div>
                            <div class="key"></div>
                            <div class="key"></div>
                            <div class="key"></div>
                            <div class="key"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Phone Number Input -->
                <div id="step-1-phone" class="step w-full max-w-sm">
                    <h1 class="text-xl font-bold mt-8 mb-2">ເຂົ້າສູ່ລະບົບດ້ວຍເບີມືຖື</h1>
                    <p class="text-sm text-gray-600 mb-6">
                        ປ້ອນເລກໂທລະສັບຂອງທ່ານ ພວກເຮົາຈະສົ່ງ OTP ສຳຫລັບການຢືນຢັນ
                    </p>

                    <input type="tel" id="phone-number-input"
                        class="w-full p-3 mb-6 border border-gray-300 rounded-md text-lg text-center"
                        placeholder="ປ້ອນເບີໂທລະສັບ (8 ຕົວເລກ)" maxlength="8">

                    <p class="text-sm text-unitel-orange mb-6 font-medium">
                        ຕ້ອງໃສ່ເບີໂທລະສັບ
                    </p>

                    <button onclick="goToOtpStep()"
                        class="button-submit bg-unitel-orange hover:bg-unitel-dark-orange text-white p-3 rounded-md font-bold w-full transition duration-200">
                        ຕໍ່ໄປ
                    </button>
                </div>

                <!-- Step 2: OTP Input (Initially Hidden) -->
                <div id="step-2-otp" class="step hidden w-full max-w-sm relative">
                    <!-- Back button for Step 2 -->
                    <div class="w-full text-left mb-4 -ml-6 sm:-ml-10">
                        <button onclick="goToPhoneStep()"
                            class="text-gray-600 hover:text-unitel-orange text-2xl p-2 transition duration-150">
                            &leftarrow;
                        </button>
                    </div>
                    <h1 class="text-xl font-bold mb-2">ປ້ອນລະຫັດທີ່ໄດ້ຮັບ</h1>
                    <p id="otp-instruction" class="text-sm text-gray-600 mb-6">
                        ປ້ອນລະຫັດ 6 ຕົວທີ່ສົ່ງໄປທີ່ 020...
                    </p>

                    <input type="text" id="otp-input"
                        class="otp-input-field w-full p-3 mb-4 border border-gray-300 rounded-md text-xl"
                        placeholder="000 000" maxlength="6">

                    <div class="flex justify-center items-center space-x-2 mb-6 text-sm">
                        <span id="countdown-timer" class="text-gray-500"></span>
                        <a href="#" onclick="resendOtp(event)" id="resend-link"
                            class="text-unitel-orange font-medium hidden">
                            ຂໍລະຫັດໃໝ່ໄດ້ຢູ່ບ່ອນນີ້
                        </a>
                    </div>

                    <button onclick="verifyOtp()"
                        class="button-submit bg-unitel-orange hover:bg-unitel-dark-orange text-white p-3 rounded-md font-bold w-full transition duration-200">
                        ຢືນຢັນ
                    </button>
                </div>
            </div>
            <!-- End of Auth Steps Container -->

            <!-- Step 3: Registration Required (After successful OTP) -->
            <div id="step-3-not-registered" class="content-padding hidden text-center">

                <!-- Status Bar: Warning/Not Registered -->
                <div
                    class="flex flex-col items-center bg-warning-light text-warning-dark p-6 rounded-lg font-bold mb-10 shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mb-3" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.365 2.722-1.365 3.487 0a1.75 1.75 0 011.018 1.583v.015a1.75 1.75 0 01-1.018 1.583c-.765 1.365-2.722 1.365-3.487 0a1.75 1.75 0 01-1.018-1.583v-.015a1.75 1.75 0 011.018-1.583zM10 12.5a1 1 0 100-2 1 1 0 000 2z"
                            clip-rule="evenodd" />
                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16z" stroke="currentColor" stroke-width="2"
                            fill="none" />
                    </svg>
                    <span class="text-xl">ເບີໂທລະສັບຂອງທ່ານຍັງບໍ່ໄດ້ລົງທະບຽນ</span>
                    <span id="unregistered-phone" class="text-2xl font-extrabold mt-3 text-gray-800">020 XXXXXXXX</span>
                </div>

                <h2 class="text-md font-medium text-gray-700 mb-8">
                    ກະລຸນາດຳເນີນການເພື່ອໃຊ້ງານຕໍ່
                </h2>

                <!-- Action Buttons -->
                <div class="space-y-4">
                    <button onclick="showModal('ປ່ຽນປະເພດ', 'ຫນ້ານີ້ຄວນຈະນຳໄປສູ່ການເລືອກປະເພດລູກຄ້າ')"
                        class="bg-gray-200 text-gray-700 py-3 rounded-md font-bold w-full transition duration-200 hover:bg-gray-300">
                        ປ່ຽນປະເພດ
                    </button>
                    <button onclick="goToRegistrationForm()"
                        class="bg-unitel-orange text-white py-3 rounded-md font-bold w-full transition duration-200 hover:bg-unitel-dark-orange">
                        <span class="mr-2">&#x1F4F1;</span> ລົງທະບຽນ eKYC
                    </button>
                    <button onclick="goToOtpStepFromNotRegistered()"
                        class="bg-white text-unitel-orange border-2 border-unitel-orange py-3 rounded-md font-bold w-full transition duration-200 hover:bg-unitel-orange hover:text-white">
                        ກັບຄືນ KYC ທີບໍ່ສຳຄັນ
                    </button>
                </div>
            </div>

            <!-- Step 4: eKYC Registration Form -->
            <div id="step-4-registration-form" class="content-padding hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">
                    ຟອມລົງທະບຽນ eKYC
                </h2>

                <form id="ekyc-form">
                    <div class="form-group">
                        <label for="input-fullName">ຊື່ ແລະ ນາມສະກຸນ</label>
                        <input type="text" id="input-fullName" required placeholder="ຊື່ເຕັມ">
                    </div>
                    <div class="form-group">
                        <label for="input-dob">ວັນເດືອນປີເກີດ</label>
                        <input type="date" id="input-dob" required>
                    </div>
                    <div class="form-group">
                        <label for="input-gender">ເພດ</label>
                        <select id="input-gender" required>
                            <option value="">ເລືອກເພດ</option>
                            <option value="ຊາຍ">ເພດຊາຍ</option>
                            <option value="ຍິງ">ເພດຍິງ</option>
                            <option value="ອື່ນໆ">ອື່ນໆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="input-nationality">ສັນຊາດ</label>
                        <input type="text" id="input-nationality" required placeholder="ຕົວຢ່າງ: ລາວ / China">
                    </div>
                    <div class="form-group">
                        <label for="input-idNumber">ເລກທີ່ເອກະສານ</label>
                        <input type="text" id="input-idNumber" required placeholder="ເລກທີ່ບັດປະຈຳຕົວ ຫຼື ໜັງສືຜ່ານແດນ">
                    </div>
                    <div class="form-group">
                        <label for="input-expireDate">ວັນທີໝົດອາຍຸ</label>
                        <input type="date" id="input-expireDate" required>
                    </div>
                    <div class="form-group">
                        <label for="input-issueCountry">ອອກໃຫ້ປະເທດ</label>
                        <input type="text" id="input-issueCountry" required placeholder="ປະເທດທີ່ອອກໃຫ້">
                    </div>
                    <div class="form-group">
                        <label for="input-issuer">ແຂວງ (ຜູ້ອອກໃຫ້)</label>
                        <input type="text" id="input-issuer" required placeholder="ແຂວງ/ເຈົ້າຫນ້າທີ່ອອກໃຫ້">
                    </div>
                    <div class="form-group">
                        <label for="input-city">ເມືອງ</label>
                        <input type="text" id="input-city" required placeholder="ເມືອງປັດຈຸບັນ">
                    </div>
                    <div class="form-group">
                        <label for="input-village">ບ້ານ</label>
                        <input type="text" id="input-village" required placeholder="ບ້ານປັດຈຸບັນ">
                    </div>
                    <div class="form-group">
                        <label for="input-address">ທີ່ຢູ່ລະອຽດປັດຈຸບັນ</label>
                        <textarea id="input-address" rows="3" required placeholder="ປ້ອນທີ່ຢູ່ລະອຽດ"></textarea>
                    </div>

                    <button type="submit"
                        class="bg-unitel-orange text-white py-3 rounded-md font-bold w-full transition duration-200 hover:bg-unitel-dark-orange mt-4">
                        ລົງທະບຽນ eKYC
                    </button>
                </form>
            </div>


            <!-- Step 5: Data Display (Confirmed Successfully) -->
            <div id="step-5-data-display" class="content-padding hidden p-4 sm:p-0 pt-10">
                <!-- Status Bar: Success/Confirmed -->
                <div
                    class="flex items-center bg-success-light text-success-dark p-3 rounded-lg font-bold mb-8 shadow-sm">
                    <!-- Icon SVG: Checkmark -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" viewBox="0 0 20 20"
                        fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>ສະຖານະ: ຢືນຢັນສຳເລັດ</span>
                </div>

                <h2 class="text-lg font-bold text-gray-800 mb-4">ຂໍ້ມູນລູກຄ້າ</h2>

                <!-- Data Display Rows Container -->
                <div id="user-data-list" class="mb-8">
                    <!-- Rows will be injected here by JavaScript -->
                </div>

                <p class="text-sm text-unitel-orange text-center mb-10 cursor-pointer font-medium">
                    ເບິ່ງເພີ່ມເຕີມ
                </p>

                <!-- Action Button for Step 5: Go back to Step 1 (Phone Input) -->
                <div class="space-y-4">
                    <button onclick="goToPhoneStep()"
                        class="bg-unitel-orange text-white py-3 rounded-md font-bold w-full transition duration-200 hover:bg-unitel-dark-orange">
                        ກັບຄືນໜ້າທຳອິດ
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Custom Modal for Messages (Instead of alert()) -->
    <div id="custom-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg font-bold mb-3"></h3>
            <p id="modal-message" class="mb-5"></p>
            <button onclick="closeModal()"
                class="bg-unitel-orange text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-unitel-dark-orange transition duration-200">
                ຕົກລົງ
            </button>
        </div>
    </div>

    <script>
        // Global State & Constants
        let simulatedOtp = '';
        let countdownSeconds = 60;
        let countdownInterval = null;

        // Global User Data State - Initial state is not registered
        let userData = {
            phoneNumber: '',
            fullName: 'N/A',
            dob: 'N/A',
            gender: 'N/A',
            nationality: 'N/A',
            idNumber: 'N/A',
            issueDate: 'N/A',
            expireDate: 'N/A',
            issueCountry: 'N/A',
            issuer: 'N/A',
            city: 'N/A',
            village: 'N/A',
            address: 'N/A',
            isRegistered: false // KEY: Controls flow after OTP
        };

        // DOM Elements
        const PHONE_DISPLAY = document.getElementById('phone-display');
        const AUTH_STEPS_CONTAINER = document.getElementById('auth-steps-container');
        const FIXED_HEADER = document.getElementById('fixed-header');
        const HEADER_BACK_BUTTON = document.getElementById('header-back-button');
        const STEP_PHONE = document.getElementById('step-1-phone');
        const STEP_OTP = document.getElementById('step-2-otp');
        const STEP_NOT_REGISTERED = document.getElementById('step-3-not-registered');
        const STEP_REGISTRATION_FORM = document.getElementById('step-4-registration-form');
        const STEP_DATA_DISPLAY = document.getElementById('step-5-data-display');
        const PHONE_INPUT = document.getElementById('phone-number-input');
        const OTP_INPUT = document.getElementById('otp-input');
        const OTP_INSTRUCTION = document.getElementById('otp-instruction');
        const RESEND_LINK = document.getElementById('resend-link');
        const COUNTDOWN_TIMER = document.getElementById('countdown-timer');
        const UNREGISTERED_PHONE = document.getElementById('unregistered-phone');
        const USER_DATA_LIST = document.getElementById('user-data-list');
        const EKYC_FORM = document.getElementById('ekyc-form');


        // Data structure for display (same keys as userData)
        const dataRowsTemplate = [
            { label: "ຊື່ ແລະ ນາມສະກຸນ", key: "fullName" },
            { label: "ວັນເດືອນປີເກີດ", key: "dob" },
            { label: "ເພດ", key: "gender" },
            { label: "ສັນຊາດ", key: "nationality" },
            { label: "ເລກທີ່ເອກະສານ", key: "idNumber" },
            { label: "ວັນທີໝົດອາຍຸ", key: "expireDate" },
            { label: "ອອກໃຫ້ປະເທດ", key: "issueCountry" },
            { label: "ແຂວງ", key: "issuer" },
            { label: "ເມືອງ", key: "city" },
            { label: "ບ້ານ", key: "village" },
            { label: "ທີ່ຢູ່ລະອຽດປັດຈຸບັນ", key: "address" },
        ];


        // --- Utility Functions (Custom Modal) ---

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        // --- OTP Countdown Logic ---

        function startCountdown() {
            countdownSeconds = 60; // Reset timer to 60 seconds
            RESEND_LINK.classList.add('hidden');
            COUNTDOWN_TIMER.classList.remove('hidden');

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                countdownSeconds--;
                COUNTDOWN_TIMER.textContent = `(${countdownSeconds} ວິ) ກ່ອນທີ່ຈະຂໍລະຫັດໃໝ່`;

                if (countdownSeconds <= 0) {
                    clearInterval(countdownInterval);
                    COUNTDOWN_TIMER.classList.add('hidden');
                    RESEND_LINK.classList.remove('hidden');
                    COUNTDOWN_TIMER.textContent = '';
                }
            }, 1000);
        }

        // --- Step Navigation Functions (Backwards) ---

        function hideAllSteps(showAuthContainer = false) {
            // Hide all step views
            [STEP_PHONE, STEP_OTP, STEP_NOT_REGISTERED, STEP_REGISTRATION_FORM, STEP_DATA_DISPLAY].forEach(el => el.classList.add('hidden'));

            // Hide/Show Auth Container (which holds Step 1 & 2)
            if (showAuthContainer) {
                AUTH_STEPS_CONTAINER.classList.remove('hidden');
            } else {
                AUTH_STEPS_CONTAINER.classList.add('hidden');
            }

            // Hide fixed header by default for clean slate
            FIXED_HEADER.classList.add('hidden');
        }

        function updateHeader(title, backFunction) {
            document.getElementById('header-title').textContent = title;
            HEADER_BACK_BUTTON.setAttribute('onclick', backFunction);
            FIXED_HEADER.classList.remove('hidden');
        }

        function goToPhoneStep() {
            // Navigates from any step back to Step 1 (Phone Input)
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            // Reset state
            OTP_INPUT.value = '';
            PHONE_INPUT.value = userData.phoneNumber.substring(3); // Keep only 8 digits if possible
            userData.phoneNumber = '';

            hideAllSteps(true);
            STEP_PHONE.classList.remove('hidden');
            PHONE_DISPLAY.textContent = '020 XXX XXXX';
        }

        function goToOtpStepFromNotRegistered() {
            // Navigates from Step 3 back to Step 2
            hideAllSteps(true);
            STEP_OTP.classList.remove('hidden');

            // Restart countdown logic to show 'Resend' link
            clearInterval(countdownInterval);
            COUNTDOWN_TIMER.classList.add('hidden');
            RESEND_LINK.classList.remove('hidden');

            OTP_INPUT.value = '';
        }

        function goToRegistrationRequiredFromForm() {
            // Navigates from Step 4 back to Step 3
            hideAllSteps();
            STEP_NOT_REGISTERED.classList.remove('hidden');
            updateHeader('eKYC', 'goToOtpStepFromNotRegistered()');
        }

        // --- Step Navigation Functions (Forwards) ---

        function goToOtpStep() {
            const phone = PHONE_INPUT.value.trim();

            if (!/^\d{8}$/.test(phone)) {
                showModal("ຂໍອະໄພ", "ກະລຸນາປ້ອນເບີໂທລະສັບ 8 ຕົວເລກທີ່ຖືກຕ້ອງ");
                return;
            }

            userData.phoneNumber = '020' + phone;

            // 1. Simulate sending OTP (Generate a random 6-digit OTP for testing)
            simulatedOtp = Math.floor(100000 + Math.random() * 900000).toString();

            // 2. Update UI for Step 2
            hideAllSteps(true);
            STEP_OTP.classList.remove('hidden');

            // 3. Update text with masked phone number
            const maskedPhone = phone.substring(0, 3) + ' XXX ' + phone.substring(6, 8);
            OTP_INSTRUCTION.textContent = `ປ້ອນລະຫັດ 6 ຕົວທີ່ສົ່ງໄປທີ່ 020${maskedPhone}`;
            PHONE_DISPLAY.textContent = `020 ${maskedPhone}`;

            // 4. Start the countdown timer
            startCountdown();

            // 5. Inform the user of the simulated OTP (for testing purposes)
            showModal("ລະຫັດ OTP ຖືກສົ່ງແລ້ວ (ສຳລັບການທົດສອບ)", `ເບີ: 020${phone}\nລະຫັດ OTP ຄື: ${simulatedOtp}`);
        }

        function resendOtp(event) {
            event.preventDefault();
            simulatedOtp = Math.floor(100000 + Math.random() * 900000).toString();
            startCountdown();
            showModal("ລະຫັດ OTP ຖືກສົ່ງອີກຄັ້ງ", `ລະຫັດ OTP ໃໝ່ຄື: ${simulatedOtp}`);
        }

        function verifyOtp() {
            const enteredOtp = OTP_INPUT.value.trim();

            if (!/^\d{6}$/.test(enteredOtp)) {
                showModal("ຂໍອະໄພ", "ລະຫັດ OTP ຕ້ອງມີ 6 ຕົວເລກ");
                return;
            }

            if (enteredOtp === simulatedOtp) {
                // Stop the countdown
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }

                // Flow decision based on registration status
                if (userData.isRegistered) {
                    goToDataDisplayStep();
                } else {
                    goToRegistrationRequired();
                }
            } else {
                showModal("ຜິດພາດ", "ລະຫັດ OTP ບໍ່ຖືກຕ້ອງ. ກະລຸນາລອງໃໝ່.");
            }
        }

        function goToRegistrationRequired() {
            // Navigates to Step 3: Not Registered screen
            hideAllSteps();
            STEP_NOT_REGISTERED.classList.remove('hidden');

            // Update phone number display
            const phone = userData.phoneNumber.substring(3);
            const maskedPhone = phone.substring(0, 3) + ' XXX ' + phone.substring(6, 8);
            UNREGISTERED_PHONE.textContent = `020 ${maskedPhone}`;

            // Update fixed header and back action
            updateHeader('eKYC', 'goToOtpStepFromNotRegistered()');
        }

        function goToRegistrationForm() {
            // Navigates to Step 4: Registration Form
            hideAllSteps();
            STEP_REGISTRATION_FORM.classList.remove('hidden');

            // Update fixed header and back action
            updateHeader('ລົງທະບຽນ eKYC', 'goToRegistrationRequiredFromForm()');
        }

        function submitRegistration(event) {
            event.preventDefault(); // Prevent default form submission

            // Simple client-side validation check (Tailwind required attribute handles most)
            const formElements = EKYC_FORM.elements;
            let allValid = true;

            // Collect and update user data
            userData.fullName = formElements['input-fullName'].value;
            userData.dob = formElements['input-dob'].value;
            userData.gender = formElements['input-gender'].value;
            userData.nationality = formElements['input-nationality'].value;
            userData.idNumber = formElements['input-idNumber'].value;
            // Assuming issueDate is today for simplicity, but user only inputs expireDate
            userData.issueDate = new Date().toLocaleDateString('lo-LA');
            userData.expireDate = formElements['input-expireDate'].value;
            userData.issueCountry = formElements['input-issueCountry'].value;
            userData.issuer = formElements['input-issuer'].value;
            userData.city = formElements['input-city'].value;
            userData.village = formElements['input-village'].value;
            userData.address = formElements['input-address'].value;

            // Check if all fields are populated (simple check for required attributes)
            for (let i = 0; i < formElements.length; i++) {
                if (formElements[i].tagName !== 'BUTTON' && formElements[i].required && formElements[i].value === '') {
                    allValid = false;
                    break;
                }
            }

            if (allValid) {
                userData.isRegistered = true; // Set status to confirmed

                showModal("ສຳເລັດ", "ການລົງທະບຽນ eKYC ສໍາເລັດແລ້ວ!");

                // Navigate to the Confirmed Data Display screen
                goToDataDisplayStep();
            } else {
                showModal("ຜິດພາດ", "ກະລຸນາປ້ອນຂໍ້ມູນໃຫ້ຄົບຖ້ວນທຸກຊ່ອງ.");
            }
        }

        function goToDataDisplayStep() {
            // Navigates to Step 5: Confirmed Data Display
            hideAllSteps();
            STEP_DATA_DISPLAY.classList.remove('hidden');

            // Update fixed header and back action
            updateHeader('eKYC', 'goToPhoneStep()'); // Step 5 back button goes to Step 1

            // Render Data Rows using the newly registered user data
            renderUserData();
        }

        function renderUserData() {
            USER_DATA_LIST.innerHTML = ''; // Clear previous content

            dataRowsTemplate.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'data-row';

                // Label
                const labelDiv = document.createElement('div');
                labelDiv.className = 'data-label';
                labelDiv.textContent = row.label;

                // Value (Pull from global userData)
                const valueDiv = document.createElement('div');
                valueDiv.className = 'data-value';
                let value = userData[row.key] || '-';

                // Format dates for display if they are not N/A
                if ((row.key === 'dob' || row.key === 'expireDate') && value !== 'N/A') {
                    try {
                        value = new Date(value).toLocaleDateString('lo-LA', {
                            year: 'numeric',
                            month: 'numeric',
                            day: 'numeric'
                        });
                    } catch (e) {
                        // Keep original value if date parsing fails
                    }
                }

                // For issueDate, use the stored value which is set upon submission
                if (row.key === 'issueDate' && value === 'N/A') {
                    // Set a placeholder or today's date if not set during registration
                    value = new Date().toLocaleDateString('lo-LA', {
                        year: 'numeric',
                        month: 'numeric',
                        day: 'numeric'
                    });
                }

                // For phone number
                if (row.key === 'idNumber') {
                    // Inject Phone number for visual reference (since it's the anchor)
                    const phoneElement = document.createElement('div');
                    phoneElement.className = 'text-xs text-gray-500 mt-1';
                    phoneElement.textContent = `ເບີໂທ: ${userData.phoneNumber}`;
                    valueDiv.appendChild(phoneElement);
                }


                valueDiv.textContent = value;

                rowDiv.appendChild(labelDiv);
                rowDiv.appendChild(valueDiv);
                USER_DATA_LIST.appendChild(rowDiv);
            });
        }

        // --- Event Listeners and Initialization ---

        // Attach event listener for form submission
        EKYC_FORM.addEventListener('submit', submitRegistration);

        // Initialize: Ensure only the phone step is visible on load
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial state: only phone step is visible
            hideAllSteps(true);
            STEP_PHONE.classList.remove('hidden');
        });

    </script>
</body>

</html>
